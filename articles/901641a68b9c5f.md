---
title: "主成分分析の理論"
emoji: "🦔"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["PCA", "主成分分析", "PrincipleComponentAnalysis"]
published: True
---
# 対象読者
この資料は、主成分分析の理論を知りたい人に向けに書きました。

* [主成分分析についての説明](#主成分分析について)
* [主成分分析がデータの分散共分散行列に対する固有値問題として与えられることの導出](#主成分分析の理論)
* [主成分分析に関連した用語と、その具体的な計算方法](#関連用語と計算方法)
* [主成分分析の例題と解答](#主成分分析の具体例-1)

という資料構成になっていますので、必要な箇所を読んで行ってください。

# 主成分分析について
## 主成分分析とは
主成分分析とは、多次元のデータを少量の新しい変数（主成分）に変換して、データの構造をわかりやすくする統計手法です。  
具体的には、データの分散が大きくなるような基底ベクトルをいくつか計算し、データを圧縮します。

:::details 例えば  
あなたが教師を務める学校で、
* 生徒全員が同じような点数を取ったテスト
* 生徒全員がばらばらの点数を取ったテスト

があったとします。

このテスト結果から優秀な生徒を見極めるためには、生徒全員がばらばらの点数を取ったテストを重視すべきです。なぜなら、生徒全員が同じような点数を取ったテストでは、生徒の優秀さよりも生徒のケアレスミスを大きく反映していると考えられるからです。

これは即ち「ばらばらの度合いが大きい（分散が大きい）ほど情報量が多い」ということであり、ここから考えられた次元圧縮方法が主成分分析です。

:::

統計問題としての主成分分析は、データの分散共分散行列に対する固有値問題として与えられるのですが、この資料ではその導出を行っています。

## 主成分分析の具体例
30人の生徒がいるクラスで、国語、数学のテスト結果から、「優秀さ」を表す軸を作ることを目的に、主成分分析を行ってみました。

:::details 具体例  
ここを書く！具体例と最終結果を見せる

:::

＊一般的には「テストの合計点」=「優秀さ」と評価していますが、主成分分析を行うことで、教科ごとに適切な重み付けした優秀さを表す指標を作ることができます。

# 主成分分析の理論
## 取り扱う問題
主成分分析の目的は「データの分散が最も大きくなるような基底を探す」ことです。
$n$ 個のデータ $\bm{x_i}$ を、ある基底 $\bm{e}$ に写したとき、分散は以下のようになります。

$$
s = \frac{1}{n} \sum_{i=1}^{n} ( \bm{x_i}^{\mathrm{T}} \bm{e} - \bm{\bar{x}_i}^{\mathrm{T}}\bm{e} )^2
$$
ここで、$\bm{\bar{x}_i}$ はデータの平均を表しています。
データが標準化されているとすれば、平均が $0$ なので以下のように書き直すことができます。

$$
s = \frac{1}{n} \sum_{i=1}^{n} (\bm{x_i}^{\mathrm{T}} \bm{e})^2
$$
ここで $\bm{e}$ が基底であることを考慮すると（$\bm{e}^{\mathrm{T}}\bm{e} = 1$）主成分分析の問題は以下のように書くことができます。

:::message
主成分分析の問題

$$
\bm{e} = \argmax_{\bm{e^*}} \frac{1}{n} \sum_{i=1}^{n} (\bm{x_i}^{\mathrm{T}} \bm{e^*})^2, \quad \bm{e^*}^{\mathrm{T}}\bm{e^*} = 1
$$

:::

## ラグランジュ未定乗数法
:::details ラグランジュ未定乗数法
「ある条件 $g(x, y)=0$ のもとで、ある関数 $f(x, y)$ が最大となるような $x, y$ を求める」
という問題は、まさにラグランジュ未定乗数法で解けることが知られています。

ラグランジュ未定乗数法とは、$g(x, y)=0$ のもとで $f(x, y)$ が最大となるとき、
$f(x,y)$ の等高線における偏微分と、$g(x,y)$ における偏微分の向きが一致すること、つまり

$$
\nabla f = \lambda \nabla g, \quad \lambda \in \mathbb{R}
$$

を利用した、非常にエレガントな解き方です。  
[参考(wikipedia)](https://ja.wikipedia.org/wiki/%E3%83%A9%E3%82%B0%E3%83%A9%E3%83%B3%E3%82%B8%E3%83%A5%E3%81%AE%E6%9C%AA%E5%AE%9A%E4%B9%97%E6%95%B0%E6%B3%95#:~:text=%E3%83%A9%E3%82%B0%E3%83%A9%E3%83%B3%E3%82%B8%E3%83%A5%E3%81%AE%E6%9C%AA%E5%AE%9A%E4%B9%97%E6%95%B0%E6%B3%95%EF%BC%88%E3%83%A9%E3%82%B0%E3%83%A9%E3%83%B3%E3%82%B8%E3%83%A5%E3%81%AE%E3%81%BF%E3%81%A6%E3%81%84%E3%81%98%E3%82%87%E3%81%86%E3%81%99%E3%81%86,%E7%9A%84%E3%81%AA%E6%96%B9%E6%B3%95%E3%81%A7%E3%81%82%E3%82%8B%E3%80%82)
:::

主成分分析の問題では、ラグランジュ未定乗数法の $g, f$ が以下のように対応しています。

$$
\begin{aligned}
g(\bm{e}) &= \bm{e}^{\mathrm{T}}\bm{e} - 1 = 0\\
f(\bm{e}) &= \frac{1}{n} \sum_{i=1}^{n} (\bm{x_i}^{\mathrm{T}} \bm{e})^2
\end{aligned}
$$
$f(\bm{e})$ を少し変形すると、問題は以下のように書き換えられます。

:::details 式変形

$$
\begin{aligned}
f(\bm{e})
&= \frac{1}{n} \sum_{i=1}^{n} (\bm{x_i}^{\mathrm{T}} \bm{e})^2 \\
&= \frac{1}{n} \sum_{i=1}^{n} \left(
(x_{i1}, x_{i2}, \dots , x_{im})
\begin{pmatrix}
   e_{1} \\
   e_{2} \\
   \vdots \\
    e_{m}
\end{pmatrix}
\right)^2 \\
&= \frac{1}{n} \sum_{i=1}^{n} ( x_{i1}^2 e_1^2 + x_{i2}^2 e_2^2 + \dots + x_{im}^2 e_m^2 )\\
&= \frac{1}{n} \sum_{i=1}^{n}
(e_{1}, e_{2}, \dots , e_{m})
\begin{pmatrix}
   x_{i1} \\
   x_{i2} \\
    \vdots \\
    x_{im}
\end{pmatrix}
(x_{i1}, x_{i2}, \dots , x_{im})
\begin{pmatrix}
   e_{1} \\
   e_{2} \\
   \vdots \\
    e_{m}
\end{pmatrix}\\
&= \frac{1}{n} \sum_{i=1}^{n} \bm{e}^{\mathrm{T}} \bm{x_i}\bm{x_i}^{\mathrm{T}} \bm{e} \\
&= \frac{\bm{e}^{\mathrm{T}} }{n} \sum_{i=1}^{n}\bm{x_i}\bm{x_i}^{\mathrm{T}} \bm{e} \\
\end{aligned}
$$
ここで、行列を

$$
\bm{C} = \frac{1}{n} \sum_{i=1}^{n} \bm{x_i}\bm{x_i}^{\mathrm{T}}
$$
とおくと、

$$
f(\bm{e}) = \bm{e}^{\mathrm{T}} \bm{C} \bm{e}
$$

:::

:::message
ラグランジュ未定乗数法を使って書き換えた、主成分分析の問題

$$
\nabla \left( \bm{e}^{\mathrm{T}} \bm{C} \bm{e} \right) = \lambda \nabla \left( \bm{e}^{\mathrm{T}}\bm{e} - 1 \right) 
$$
:::

## 固有値問題
この偏微分を計算すると、

$$
\begin{aligned}
\nabla \left( \bm{e}^{\mathrm{T}} \bm{C} \bm{e} \right) &= \lambda \nabla \left( \bm{e}^{\mathrm{T}}\bm{e} - 1 \right) \\
2 \bm{C} \bm{e} &= 2 \lambda \bm{e} \\
\therefore \bm{C} \bm{e} &= \lambda \bm{e}
\end{aligned}
$$
となり、以下のような固有値問題が得られます。

:::message
最終的に解きたい固有値問題

$$
\bm{C} = \frac{1}{n} \sum_{i=1}^{n} \bm{x_i}\bm{x_i}^{\mathrm{T}}
$$
という行列に対する

$$
\bm{C} \bm{e} = \lambda \bm{e}
$$
が成り立つ $\bm{e}$ と $\lambda$ を求める問題。
:::

:::details 分散共分散行列について
ここを書く

:::

:::details 固有値が分散となることの説明
ここを書く

:::

# 関連用語と計算方法
## 寄与度
## 累積寄与度
## 主成分得点

# 主成分分析の具体例
## 例題（主成分分析の具体例セクションで見せた部分）
## 解答


# 以下、メモ書き
:::details 分散共分散行列について  
ここで、$\frac{1}{k}$ をかけておいた理由を説明しておきます。  
標準化したデータにおいて、

$$
\bm{C} = \frac{1}{k} \sum_{i=1}^{k} \bm{x_i}\bm{x_i}^{\mathrm{T}}
$$

このような行列のことを、分散共分散行列と言い、これは元のデータから簡単に計算することができます。  
つまり、分散共分散行列を計算し、固有値問題を解くだけで主成分は計算できるのです。

:::

$\lambda$ と、それに対応するベクトル $\bm{e}$ は複数与えられますが、$\lambda$ が大きいものから順に「第n負荷量ベクトル」と呼びます。  
また、$\lambda$ 自身も「寄与度」、「累積寄与度」を計算する上で非常に重要な役割を果たします。

## 寄与度

計算した $\lambda$ を大きいのもから順に $\lambda_1 , \lambda_2, ... \lambda_i$ と呼ぶことにすると、第 $j$ 主成分の寄与度を

$$
\frac{\lambda_j}{\sum^{i}_{k=1} \lambda_k}
$$

と定義します。

## 累積寄与度

計算した $\lambda$ を大きいのもから順に $\lambda_1 , \lambda_2, ... \lambda_i$ と呼ぶことにすると、第 $j$ 主成分までの累積寄与度を

$$
\frac{\sum^{i}_{l=1} \lambda_l}{\sum^{i}_{k=1} \lambda_k}
$$

と定義します。